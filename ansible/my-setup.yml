---
- hosts: lamp
  become: yes
  tasks:
    - name: Setup for CentOS
      when:
        - ansible_distribution == "CentOS"
      block:
        - name: Enable EPEL
          package:
            name: epel-release
            state: present
            update_cache: yes
        - name: Setup MySQL repo - CentOS 6
          when:
            - ansible_distribution_major_version == "6"
          package:
            name: https://dev.mysql.com/get/mysql80-community-release-el6-4.noarch.rpm
            state: present
        - name: Setup MySQL repo - CentOS 7
          when:
            - ansible_distribution_major_version == "7"
          package:
            name: https://dev.mysql.com/get/mysql80-community-release-el7-4.noarch.rpm
            state: present
    - name: Install MySQL server and PHP
      package:
        name: 
          - mysql-server
          - php
          - php-mysql
        state: present
    - name: Install LAMP - CentOS
      when:
        - ansible_distribution == "CentOS"
      block:
        - name: Install httpd
          package:
            name:
              - httpd
            state: present
        - name: Enable and start httpd
          service:
            name: httpd
            enabled: yes
            state: started
        - name: Enable mysql-server
          service:
            name: mysqld
            enabled: yes
        
    - name: Install LAMP - Ubuntu
      when:
        - ansible_distribution == "Ubuntu"
      block:
        - name: Install apache2
          package:
            name:
              - apache2
              - libapache2-mod-php
            state: present
        - name: Enable and start apache2
          service:
            name: apache2
            enabled: yes
            state: started
        - name: Enable and start mysql-server
          service:
            name: mysql
            enabled: yes

    - name: Create customize index.html
      blockinfile:
        path: /var/www/html/index.html
        marker: <!-- {mark} index.html -->
        insertbefore: BOF
        create: yes
        block: |
          <html>
          <title>Test page for LCA2022</title>
          <body>
          <h1>LCA2022 - Test landing page</h1>
          <h2>{{ ansible_hostname }}</h2>
          <p>Welcome to LCA2022!<p>
          This is running on {{ ansible_hostname }}, OS: {{ ansible_distribution }}, Version: {{ ansible_distribution_major_version }}
          </body>
          </html>
 
    - name: Create customize info.php
      blockinfile:
        path: /var/www/html/info.php
        marker: <!-- {mark} info.php -->
        create: yes
        block: |
          <?php phpinfo(); ?>
